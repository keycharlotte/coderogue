name: Deploy Statistics Visualization

on:
  push:
    branches: [ main, master ]
    paths:
      - 'stats_visualization.html'
      - 'historical_stats.json'
      - 'VISUALIZATION_GUIDE.md'
      - 'index.html'
      - '*.ps1'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿ç”Ÿæˆå†å²ç»Ÿè®¡
        
    - name: Generate latest statistics and visualization
      shell: pwsh
      run: |
        # ç”Ÿæˆæœ€æ–°çš„é¡¹ç›®ç»Ÿè®¡
        Write-Host "ğŸ“Š Generating project statistics..."
        .\project_stats.ps1
        
        # ç”Ÿæˆå†å²ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨Gitå†å²ï¼‰
        Write-Host "ğŸ“ˆ Generating historical statistics..."
        .\generate_historical_stats.ps1 -DaysBack 180 -UseGitHistory
        
        # æ›´æ–°å¯è§†åŒ–æ•°æ®
        Write-Host "ğŸ¨ Updating visualization data..."
        .\update_stats_with_visualization.ps1 -GenerateVisualization -HistoryDays 180
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if (Test-Path "stats_visualization.html") {
            Write-Host "âœ… Visualization HTML file exists"
        } else {
            Write-Error "âŒ Visualization HTML file not found"
        }
        
        if (Test-Path "historical_stats.json") {
            Write-Host "âœ… Historical stats JSON file exists"
        } else {
            Write-Error "âŒ Historical stats JSON file not found"
        }
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Create deployment directory
      shell: pwsh
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        New-Item -ItemType Directory -Force -Path "_site"
        
        # å¤åˆ¶å¯è§†åŒ–æ–‡ä»¶
        Copy-Item "stats_visualization.html" "_site/index.html"
        Copy-Item "historical_stats.json" "_site/"
        Copy-Item "VISUALIZATION_GUIDE.md" "_site/"
        
        # åˆ›å»ºç®€å•çš„å¯¼èˆªé¡µé¢ - ä½¿ç”¨ç®€å•çš„æ–‡æœ¬æ–¹å¼é¿å…YAMLè¯­æ³•å†²çª
        $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        
        # ç›´æ¥å¤åˆ¶stats_visualization.htmlä½œä¸ºä¸»é¡µï¼Œå¹¶åˆ›å»ºç®€å•çš„å¯¼èˆªæ–‡ä»¶
        "CodeRogue é¡¹ç›®ç»Ÿè®¡å¯¼èˆª - æ›´æ–°æ—¶é—´: $timestamp" | Out-File -FilePath "_site/navigation.txt" -Encoding UTF8
        "" | Add-Content -Path "_site/navigation.txt"
        "å¯ç”¨é¡µé¢:" | Add-Content -Path "_site/navigation.txt"
        "1. é¡¹ç›®ç»Ÿè®¡å¯è§†åŒ–: stats_visualization.html" | Add-Content -Path "_site/navigation.txt"
        "2. å¯è§†åŒ–æŒ‡å—: VISUALIZATION_GUIDE.md" | Add-Content -Path "_site/navigation.txt"
        
        Write-Host "ğŸ“ Deployment files created:"
        Get-ChildItem "_site" | ForEach-Object { Write-Host "  - $($_.Name)" }
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Output deployment URL
      shell: pwsh
      run: |
        Write-Host "ğŸš€ Visualization deployed successfully!"
        Write-Host "ğŸ“Š View at: ${{ steps.deployment.outputs.page_url }}"
        Write-Host "ğŸ“ˆ Direct chart access: ${{ steps.deployment.outputs.page_url }}stats_visualization.html"