name: Deploy Statistics Visualization

on:
  push:
    branches: [ main, master ]
    paths:
      - 'stats_visualization.html'
      - 'historical_stats.json'
      - 'VISUALIZATION_GUIDE.md'
      - '*.ps1'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿ç”Ÿæˆå†å²ç»Ÿè®¡
        
    - name: Generate latest statistics and visualization
      shell: pwsh
      run: |
        # ç”Ÿæˆæœ€æ–°çš„é¡¹ç›®ç»Ÿè®¡
        Write-Host "ğŸ“Š Generating project statistics..."
        .\project_stats.ps1
        
        # ç”Ÿæˆå†å²ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨Gitå†å²ï¼‰
        Write-Host "ğŸ“ˆ Generating historical statistics..."
        .\generate_historical_stats.ps1 -DaysBack 180 -UseGitHistory
        
        # æ›´æ–°å¯è§†åŒ–æ•°æ®
        Write-Host "ğŸ¨ Updating visualization data..."
        .\update_stats_with_visualization.ps1 -GenerateVisualization -HistoryDays 180
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if (Test-Path "stats_visualization.html") {
            Write-Host "âœ… Visualization HTML file exists"
        } else {
            Write-Error "âŒ Visualization HTML file not found"
        }
        
        if (Test-Path "historical_stats.json") {
            Write-Host "âœ… Historical stats JSON file exists"
        } else {
            Write-Error "âŒ Historical stats JSON file not found"
        }
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Create deployment directory
      shell: pwsh
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        New-Item -ItemType Directory -Force -Path "_site"
        
        # å¤åˆ¶å¯è§†åŒ–æ–‡ä»¶
        Copy-Item "stats_visualization.html" "_site/index.html"
        Copy-Item "historical_stats.json" "_site/"
        Copy-Item "VISUALIZATION_GUIDE.md" "_site/"
        
        # åˆ›å»ºç®€å•çš„å¯¼èˆªé¡µé¢
        $htmlContent = @'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeRogue é¡¹ç›®ç»Ÿè®¡</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .nav-links {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        .nav-link {
            display: inline-block;
            padding: 12px 24px;
            background: #007acc;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s;
        }
        .nav-link:hover {
            background: #005a9e;
        }
        .description {
            text-align: center;
            color: #666;
            line-height: 1.6;
        }
        .update-time {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š CodeRogue é¡¹ç›®ç»Ÿè®¡å¯è§†åŒ–</h1>
        
        <div class="nav-links">
            <a href="stats_visualization.html" class="nav-link">ğŸ“ˆ æŸ¥çœ‹ç»Ÿè®¡å›¾è¡¨</a>
            <a href="VISUALIZATION_GUIDE.md" class="nav-link">ğŸ“– ä½¿ç”¨æŒ‡å—</a>
            <a href="historical_stats.json" class="nav-link">ğŸ“„ åŸå§‹æ•°æ®</a>
        </div>
        
        <div class="description">
            <p>æ¬¢è¿è®¿é—® CodeRogue é¡¹ç›®çš„ç»Ÿè®¡å¯è§†åŒ–é¡µé¢ï¼</p>
            <p>è¿™é‡Œæä¾›äº†é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­çš„å„ç§ç»Ÿè®¡æ•°æ®å’Œå¯è§†åŒ–å›¾è¡¨ï¼Œå¸®åŠ©æ‚¨äº†è§£é¡¹ç›®çš„å‘å±•å†ç¨‹ã€‚</p>
            <p>ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†çš„ç»Ÿè®¡å›¾è¡¨ã€ä½¿ç”¨æŒ‡å—æˆ–ä¸‹è½½åŸå§‹æ•°æ®ã€‚</p>
        </div>
        
        <div class="update-time">
            æœ€åæ›´æ–°æ—¶é—´: {0}
        </div>
    </div>
</body>
</html>
'@
        
        $currentTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
        $finalHtml = $htmlContent -f $currentTime
        $finalHtml | Out-File -FilePath "_site/navigation.html" -Encoding utf8
        
        Write-Host "ğŸ“ Deployment files created:"
        Get-ChildItem "_site" | ForEach-Object { Write-Host "  - $($_.Name)" }
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Output deployment URL
      shell: pwsh
      run: |
        Write-Host "ğŸš€ Visualization deployed successfully!"
        Write-Host "ğŸ“Š View at: ${{ steps.deployment.outputs.page_url }}"
        Write-Host "ğŸ“ˆ Direct chart access: ${{ steps.deployment.outputs.page_url }}stats_visualization.html"