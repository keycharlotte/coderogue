name: Project Statistics

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  stats:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run project statistics
      shell: pwsh
      run: |
        # æ‰§è¡Œé¡¹ç›®ç»Ÿè®¡è„šæœ¬
        .\project_stats.ps1
        
        # è·å–ç»Ÿè®¡ç»“æœ
        $stats = .\project_stats.ps1 -OutputJson | ConvertFrom-Json
        
        # è¾“å‡ºç»Ÿè®¡ç»“æœåˆ°GitHub Actionsæ—¥å¿—
        Write-Host "ğŸ“Š Project Statistics:"
        Write-Host "ğŸ”¢ C# Files: $($stats.CsFiles)"
        Write-Host "ğŸ“ Classes: $($stats.Classes)"
        Write-Host "ğŸ“„ Lines of Code: $($stats.CodeLines)"
        Write-Host "ğŸ¬ TSCN Files: $($stats.TscnFiles)"
        Write-Host "ğŸ“¦ TRES Files: $($stats.TresFiles)"
        
        # åˆ›å»ºç»Ÿè®¡æ‘˜è¦æ–‡ä»¶
        $summary = @"
        ## ğŸ“Š Project Statistics
        
        | Metric | Count |
        |--------|-------|
        | C# Files | $($stats.CsFiles) |
        | Classes | $($stats.Classes) |
        | Lines of Code | $($stats.CodeLines) |
        | TSCN Files | $($stats.TscnFiles) |
        | TRES Files | $($stats.TresFiles) |
        
        *Generated on $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')*
        "@
        
        # è¾“å‡ºåˆ°GitHub Actionsæ‘˜è¦
        $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
        
        # è®¾ç½®è¾“å‡ºå˜é‡ä¾›å…¶ä»–æ­¥éª¤ä½¿ç”¨
        echo "csharp_files=$($stats.CsFiles)" >> $env:GITHUB_OUTPUT
        echo "classes=$($stats.Classes)" >> $env:GITHUB_OUTPUT
        echo "lines_of_code=$($stats.CodeLines)" >> $env:GITHUB_OUTPUT
        echo "tscn_files=$($stats.TscnFiles)" >> $env:GITHUB_OUTPUT
        echo "tres_files=$($stats.TresFiles)" >> $env:GITHUB_OUTPUT
        
    - name: Generate historical statistics and visualization
      shell: pwsh
      run: |
        # ç”Ÿæˆæˆ–æ›´æ–°å†å²ç»Ÿè®¡æ•°æ®
        .\generate_historical_stats.ps1 -DaysBack 90 -UseGitHistory
        
        # æ›´æ–°å¯è§†åŒ–æ•°æ®
        .\update_stats_with_visualization.ps1 -GenerateVisualization -HistoryDays 90
        
        # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„ç»Ÿè®¡æ–‡ä»¶
        $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
        $statsFile = "project-stats-$timestamp.json"
        .\project_stats.ps1 -OutputJson | Out-File -FilePath $statsFile -Encoding utf8
        
        # åˆ›å»ºartifactsç›®å½•
        New-Item -ItemType Directory -Force -Path "artifacts"
        Move-Item $statsFile "artifacts/"
        
        # å¤åˆ¶å¯è§†åŒ–æ–‡ä»¶åˆ°artifacts
        Copy-Item "stats_visualization.html" "artifacts/"
        Copy-Item "historical_stats.json" "artifacts/"
        
    - name: Upload statistics artifact
      uses: actions/upload-artifact@v4
      with:
        name: project-statistics
        path: artifacts/
        retention-days: 30
        
    - name: Deploy visualization to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        destination_dir: stats
        keep_files: false
        include_files: |
          stats_visualization.html
          historical_stats.json
          VISUALIZATION_GUIDE.md
        
    - name: Comment PR with statistics (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–ç»Ÿè®¡æ•°æ®
          const { execSync } = require('child_process');
          const statsJson = execSync('powershell -Command ".\\project_stats.ps1 -OutputJson"', { encoding: 'utf8' });
          const stats = JSON.parse(statsJson);
          
          // åˆ›å»ºPRè¯„è®º
          const comment = `## ğŸ“Š Project Statistics
          
          | Metric | Count |
          |-----------|-------|
          | C# Files | ${stats.CsFiles} |
          | Classes | ${stats.Classes} |
          | Lines of Code | ${stats.CodeLines} |
          | TSCN Files | ${stats.TscnFiles} |
          | TRES Files | ${stats.TresFiles} |
          
          *Statistics generated automatically on ${new Date().toISOString()}*`;
          
          // å‘å¸ƒè¯„è®º
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });